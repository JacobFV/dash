{% extends "root.html" %}

{% block title %}Feature Comparison{% endblock %}
{% block banner_link %}{{ url_for('static', filename='images/graph-banner.png') }}{% endblock %}

{% block main %}

{% if data %} <!-- if the page is being loaded with graph data, generate graphs -->

<button style='float: left; margin: 20px' onclick='window.open("/graph/{{ locale }}", "_self")'>&larr; New Query</button>
<div id='dash'></div>

<script src="{{ url_for('static', filename='graphFunctions.js') }}"></script>

<!-- this script unpacks data from the server, builds the Graph object, and graphs the data -->
<script type='text/javascript'>

  let data = JSON.parse('{{ data|safe }}');
 
  let db = new Dash('dash', 500, 400, 15, `{{ feature1 }}`, `{{ feature2 }}`);

  // this assumes that all datasets cover the same time range (they will all be plotted
  // left-aligned with the horizontally 'widest' dataset)
  let xlbl = new Set();
  for (let r in data) 
    for (let day of data[r].t) xlbl.add(day.slice(0,7));
  xlbl = Array(... xlbl).sort()
    .map(m => `${monthNames[parseInt(m.slice(5))-1]} ${m.slice(0,4)}`);

  // add two datasets to the dashboard per region - for features 1 & 2
  let legend = Array();
  for (let r in data) {
    let xvals = [], c = randColor();

    // factor of 10 helps space out data (i.e. 10px wide per data point)
    for (let i = 0; i < data[r].t.length; i++) xvals.push(10 * i);

    // exclude string feature names from datasets
    db.push(DataSet( xvals, data[r]['f1'], 1, c ));
    db.push(DataSet( xvals, data[r]['f2'], 2, c ));

    legend.push([r, c]);
  }
  
  db.xlbl = xlbl;
  db.legend(legend);
  db.drawData();

</script>

{% else %} <!-- if data is not present, provide a form for the user to request data -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
<style>
  .checkbox-menu {
    top: auto; left: auto;
    max-height: 500px;
    overflow-y: scroll;
  }
  .checkbox-menu li label {
      display: block;
      padding: 3px 10px;
      clear: both;
      font-weight: normal;
      line-height: 1.42857143;
      color: #333;
      white-space: nowrap;
      margin:0;
  }
  .checkbox-menu li input {
      margin: 0px 5px;
      top: 2px;
      position: relative;
  }

  .checkbox-menu li.active label {
      background-color: #cbcbff;
      font-weight:bold;
  }

  .checkbox-menu li label:hover,
  .checkbox-menu li label:focus { background-color: #f5f5f5; }

  .checkbox-menu li.active label:hover,
  .checkbox-menu li.active label:focus { background-color: #b8b8ff; }
</style>

<script>
  $(".checkbox-menu").on("change", "input[type='checkbox']", function() { $(this).closest("li").toggleClass("active", this.checked); });
  $(document).on('click', '.allow-focus', function (e) { e.stopPropagation(); });
</script>

<div class="container-fluid ">
  <div class="card-deck bg-secondary p-3">
    <form class="container-fluid" action="/graph/results/{{ locale }}" method="POST" novalidate>

      <button class="btn btn-light dropdown-toggle" type="button" id="regionDropDown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"> Select regions...  </button>
      <ul class="dropdown-menu checkbox-menu allow-focus" aria-labelledby="regionDropDown">
        {% for r in regions %}
        <li><label><input id="{{ r }}" name="{{ r }}" type="checkbox" value="{{ r }}">{{ r }}</label></li>
        {% endfor %}
      </ul>
      
      <select id="feature1" class="card btn btn-light m-2" name="feature1" onchange="enableSubmit(id);">
        {% for f in features %} <option id = '{{ f }}' value = '{{ f }}'>{{ features[f] }}</option> {% endfor %}
      </select>

      <select id="feature2" class="card btn btn-light m-2" name="feature2" onchange="enableSubmit(id);">
        {% for f in features %} <option id='{{ f }}' value='{{ f }}'>{{ features[f] }}</option> {% endfor %}
      </select>
      
      <input id="submit" class="btn btn-light m-2" type="submit" value ="Submit">
    </form>
  </div>
</div>

{% endif %}

<div style='height:100px'></div>

{% endblock %}